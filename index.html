<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Alimentar Semanal - NutriVeg IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .tab-active {
            border-bottom-color: #10b981;
            color: #059669;
            font-weight: 600;
        }
        .checkbox-custom {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.375rem;
            border: 2px solid #d1d5db;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .checkbox-custom:checked {
            background-color: #10b981;
            border-color: #10b981;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .strikethrough-on-check:checked + label {
            text-decoration: line-through;
            color: #6b7280;
        }
        .hidden {
            display: none;
        }
        .gemini-button {
            background-color: #ecfdf5; /* emerald-50 */
            color: #065f46; /* emerald-800 */
            border: 1px solid #6ee7b7; /* emerald-300 */
            transition: all 0.2s;
        }
        .gemini-button:hover {
            background-color: #d1fae5; /* emerald-100 */
            border-color: #34d399; /* emerald-400 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-button svg {
            transition: transform 0.3s ease-out;
        }
        .whatsapp-button {
            background-color: #25D366;
            color: white;
        }
        .whatsapp-button:hover {
            background-color: #1DA851;
        }
        .pagination-button {
            background-color: #e5e7eb;
            color: #374151;
        }
        .pagination-button.active {
            background-color: #10b981;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Main App Container -->
    <div id="app-container">
        <div class="container mx-auto max-w-lg p-4">
            <header class="text-center mb-6">
                <h1 class="text-2xl font-bold text-emerald-700">Plano Alimentar Semanal üçÉ</h1>
                <p class="text-sm text-gray-500 mt-1">Organizado pela NutriVeg IA</p>
            </header>

            <div class="flex flex-wrap border-b border-gray-200 mb-6 text-xs sm:text-sm">
                <button id="tab-gerar" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('gerar')">üìù Gerar</button>
                <button id="tab-cardapio" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('cardapio')">üìÖ Card√°pio</button>
                <button id="tab-lista" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('lista')">üõí Compras</button>
                <button id="tab-receitas" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('receitas')">üç≥ Receitas</button>
                <button id="tab-nutri" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('nutri')">üë©‚Äç‚öïÔ∏è Nutri</button>
                <button id="tab-receita-rapida" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('receita-rapida')">üßë‚Äçüç≥ R√°pida</button>
                <button id="tab-cultura-mundial" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('cultura-mundial')">üåé Cultura</button>
                <button id="tab-modo-festa" class="w-1/4 flex-grow py-3 px-1 text-center text-gray-500 border-b-2 border-transparent transition-colors duration-300" onclick="showTab('modo-festa')">üéâ Festa</button>
            </div>

            <main>
                <div id="content-gerar"></div>
                <div id="content-cardapio" class="hidden"></div>
                <div id="content-lista" class="hidden"></div>
                <div id="content-receitas" class="hidden"></div>
                <div id="content-nutri" class="hidden"></div>
                <div id="content-receita-rapida" class="hidden"></div>
                <div id="content-cultura-mundial" class="hidden"></div>
                <div id="content-modo-festa" class="hidden"></div>
            </main>

            <footer class="mt-8">
                <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-r-lg text-xs">
                    <p><strong>Aten√ß√£o:</strong> Sou uma IA e n√£o substituo um profissional de sa√∫de. Para um plano personalizado e seguro, consulte um nutricionista.</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Gemini API Modal -->
    <div id="geminiModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto w-11/12">
            <h3 id="geminiModalTitle" class="text-lg font-medium text-gray-900 mb-4">‚ú® Sugest√£o da IA</h3>
            <div id="geminiModalContent" class="text-sm text-gray-600 min-h-[100px] max-h-60 overflow-y-auto">
                <div class="flex justify-center items-center h-full">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="closeGeminiModalButton" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md text-sm font-semibold hover:bg-gray-300">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // --- CONFIGURA√á√ÉO IMPORTANTE ---
        // COLE SUA CHAVE DE API DO GOOGLE AQUI DENTRO DAS ASPAS
        const GEMINI_API_KEY = "AIzaSyDGN5ON91dj0fqCFRyJGYCC2MTlyWpRyFI";
        // =================================================================================


        // --- DATA & STATE MANAGEMENT ---
        let mealPlanData = {
            cardapio: [],
            lista: {},
            receitas: [],
            estoqueInicial: ''
        };
        let cardapioCurrentPage = 1;
        let generatedWorldRecipes = [];

        // --- UI RENDERING ---
        function renderAll() {
            renderCardapio(mealPlanData.cardapio);
            renderLista(mealPlanData.lista, mealPlanData.estoqueInicial);
            renderReceitas(mealPlanData.cardapio, mealPlanData.receitas);
            renderGerar();
            renderNutri();
            renderReceitaRapida();
            renderCulturaMundial();
            renderModoFesta();
        }

        function renderPlaceholder(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-sm"><p class="text-gray-500">${message}</p></div>`;
        }

        function renderCardapio(data) {
            const container = document.getElementById('content-cardapio');
            if(!data || data.length === 0) {
                renderPlaceholder('content-cardapio', 'Gere um novo plano na aba "üìù Gerar Plano" para ver seu card√°pio.');
                return;
            }

            const shareButton = `
            <div class="mb-6 text-center">
                 <button class="whatsapp-button w-full sm:w-auto py-2 px-4 rounded-lg flex items-center justify-center" onclick='handleShareWeekToWhatsApp()'>
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.12l-1.214 4.433 4.572-1.196z"/></svg>
                    Enviar via WhatsApp
                </button>
            </div>`;
            
            const itemsPerPage = 7;
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const startIndex = (cardapioCurrentPage - 1) * itemsPerPage;
            const endIndex = cardapioCurrentPage * itemsPerPage;
            const currentWeekData = data.slice(startIndex, endIndex);

            const cardsHTML = currentWeekData.map(dia => `
                <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">${dia.dia}</h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <div><strong>Caf√©:</strong> ${dia.cafe}</div>
                        <div>
                            <p><strong>Almo√ßo:</strong> ${dia.almoco}</p>
                            <div class="flex space-x-2 mt-2">
                                <button class="gemini-button text-xs py-1 px-2 rounded-md" onclick="handleGeminiClick('variacao', 'almo√ßo', '${dia.almoco.replace(/'/g, "\\'")}')">‚ú® Varia√ß√£o</button>
                                <button class="gemini-button text-xs py-1 px-2 rounded-md" onclick="handleGeminiClick('dica', 'almo√ßo', '${dia.almoco.replace(/'/g, "\\'")}')">‚ú® Dica</button>
                            </div>
                        </div>
                        <div>
                            <p><strong>Jantar:</strong> ${dia.jantar}</p>
                             <div class="flex space-x-2 mt-2">
                                <button class="gemini-button text-xs py-1 px-2 rounded-md" onclick="handleGeminiClick('variacao', 'jantar', '${dia.jantar.replace(/'/g, "\\'")}')">‚ú® Varia√ß√£o</button>
                                <button class="gemini-button text-xs py-1 px-2 rounded-md" onclick="handleGeminiClick('dica', 'jantar', '${dia.jantar.replace(/'/g, "\\'")}')">‚ú® Dica</button>
                            </div>
                        </div>
                        <div><strong>Lanches:</strong> ${dia.lanches}</div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-100 text-center">
                        <button class="gemini-button text-xs py-1 px-3 rounded-md" onclick="handleLeftoversClick('${dia.almoco.replace(/'/g, "\\'")}', '${dia.jantar.replace(/'/g, "\\'")}')">
                           üí° O que fazer com as sobras?
                        </button>
                    </div>
                </div>
            `).join('');

            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML += `<div class="flex justify-center items-center space-x-2 mt-6">`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button class="pagination-button py-2 px-4 rounded-md text-sm ${i === cardapioCurrentPage ? 'active' : ''}" onclick="changeCardapioPage(${i})">Semana ${i}</button>`;
                }
                paginationHTML += `</div>`;
            }

            container.innerHTML = shareButton + cardsHTML + paginationHTML;
        }

        window.changeCardapioPage = function(page) {
            cardapioCurrentPage = page;
            renderCardapio(mealPlanData.cardapio);
        }

        function renderLista(listaSugerida, estoqueInicial) {
            const container = document.getElementById('content-lista');
            if ((!listaSugerida || Object.keys(listaSugerida).length === 0) && !estoqueInicial) {
                 renderPlaceholder('content-lista', 'Sua lista de compras e estoque aparecer√£o aqui ap√≥s gerar um plano.');
                return;
            }
            
            const buttonsHTML = `
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button class="gemini-button w-full py-2 px-4 rounded-lg flex items-center justify-center" onclick="handleSavingsClick()">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>
                    Dicas de Economia
                </button>
                <button class="whatsapp-button w-full py-2 px-4 rounded-lg flex items-center justify-center" onclick="handleShareListToWhatsApp()">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.475L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.12l-1.214 4.433 4.572-1.196z"/></svg>
                    Enviar via WhatsApp
                </button>
            </div>`;

            const listaSugeridaHTML = Object.keys(listaSugerida).length > 0 ? `
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-700 border-b pb-2 mb-3">üõí Lista de Compras</h3>
                    ${Object.entries(listaSugerida).map(([categoria, itens]) => `
                        <div class="mt-4">
                            <h4 class="font-medium text-gray-600">${categoria}</h4>
                            <ul class="space-y-3 mt-2">
                                ${itens.map((item, itemIndex) => `
                                    <li class="flex items-center">
                                        <input type="checkbox" id="item${categoria}-${itemIndex}" class="checkbox-custom strikethrough-on-check mr-3">
                                        <label for="item${categoria}-${itemIndex}" class="text-gray-800">${item}</label>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-sm text-center text-gray-500 mb-4">√ìtimo! Parece que voc√™ j√° tem tudo no estoque.</p>';

            const estoqueInicialHTML = estoqueInicial ? `
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-700 border-b pb-2 mb-3">üè† Seu Estoque</h3>
                    <ul class="space-y-1 text-sm text-gray-600 list-disc list-inside">
                        ${estoqueInicial.split('\n').filter(line => line.trim() !== '').map(line => `<li>${line}</li>`).join('')}
                    </ul>
                </div>
            ` : '';

            container.innerHTML = `<div class="bg-white rounded-lg shadow-sm p-4">${buttonsHTML} ${listaSugeridaHTML} ${estoqueInicialHTML}</div>`;
        }

        function renderReceitas(cardapio, receitas) {
             if(!cardapio || cardapio.length === 0) {
                renderPlaceholder('content-receitas', 'As receitas do seu plano aparecer√£o aqui.');
                return;
            }
            const container = document.getElementById('content-receitas');
            container.innerHTML = cardapio.map((dia, index) => {
                const findRecipe = (mealName) => receitas.find(r => r.titulo.trim().toLowerCase() === mealName.trim().toLowerCase());

                const receitasDoDia = {
                    'Caf√©': findRecipe(dia.cafe),
                    'Almo√ßo': findRecipe(dia.almoco),
                    'Jantar': findRecipe(dia.jantar),
                    'Lanches': findRecipe(dia.lanches)
                };

                return `
                <div class="bg-white rounded-lg shadow-sm mb-2">
                    <button class="accordion-button w-full flex justify-between items-center text-left p-4" onclick="toggleAccordion(this)">
                        <h2 class="text-lg font-bold text-emerald-600">${dia.dia}</h2>
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content px-4 pb-4">
                        ${Object.entries(receitasDoDia).map(([nomeRefeicao, receita]) => {
                            const mealDescription = dia[nomeRefeicao.toLowerCase()];
                            if (!receita) return `<div class="border-t pt-4 mt-4"><h3 class="font-semibold">${nomeRefeicao}:</h3><p class="text-sm text-gray-700">${mealDescription || 'Preparo simples, n√£o requer receita detalhada.'}</p></div>`;
                            return `
                            <div class="border-t pt-4 mt-4">
                                <h3 class="font-semibold text-gray-800 mb-2">${nomeRefeicao}: ${receita.titulo}</h3>
                                <div class="text-sm text-gray-700 space-y-3">
                                    <div>
                                        <h4 class="font-medium mb-1">Ingredientes:</h4>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${receita.ingredientes.map(ing => `<li>${ing}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 class="font-medium mb-1">Modo de Preparo:</h4>
                                        <ol class="list-decimal list-inside space-y-1">
                                            ${receita.preparo.map(passo => `<li>${passo}</li>`).join('')}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            `
                        }).join('')}
                    </div>
                </div>
                `
            }).join('');
        }
        
        function renderNutri() {
            const container = document.getElementById('content-nutri');
            const content = mealPlanData.cardapio.length > 0 ? `
                <div class="bg-white rounded-lg shadow-sm p-6 text-center">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">üë©‚Äç‚öïÔ∏è An√°lise da Nutri & Plano de A√ß√£o</h2>
                    <p class="text-sm text-gray-600 mb-4">Clique no bot√£o para receber a justificativa nutricional do seu card√°pio e um plano de a√ß√£o para preparar suas marmitas da semana!</p>
                    <button class="gemini-button w-full sm:w-auto py-2 px-4 rounded-lg" onclick="handleNutriAnalysisClick()">
                        Gerar An√°lise e Plano de A√ß√£o
                    </button>
                    <div id="nutri-result" class="text-left mt-6 text-sm text-gray-700 space-y-4"></div>
                </div>
            ` : `<div class="text-center p-8 bg-white rounded-lg shadow-sm"><p class="text-gray-500">Gere um plano primeiro para poder analis√°-lo.</p></div>`;
            container.innerHTML = content;
        }

        function renderReceitaRapida() {
            const container = document.getElementById('content-receita-rapida');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">üßë‚Äçüç≥ Gerador de Receita R√°pida</h2>
                    <p class="text-sm text-gray-600 mb-4">Tem alguns ingredientes sobrando? Liste-os abaixo e a IA criar√° 3 receitas para voc√™!</p>
                    <textarea id="quick-recipe-input" class="w-full h-24 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-400" placeholder="Ex: tomate, manjeric√£o, alho, macarr√£o..."></textarea>
                    <button class="gemini-button w-full mt-4 py-2 px-4 rounded-lg" onclick="handleQuickRecipeClick()">
                        üí° Sugerir Receitas
                    </button>
                    <div id="quick-recipe-result" class="mt-6"></div>
                </div>
            `;
        }
        
        function renderCulturaMundial() {
            const container = document.getElementById('content-cultura-mundial');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">üåé Cultura Mundial Vegetariana</h2>
                    <p class="text-sm text-gray-600 mb-4">Explore a culin√°ria vegetariana e vegana de todo o mundo. Clique no bot√£o para descobrir 3 pratos de diferentes pa√≠ses!</p>
                    <button class="gemini-button w-full mt-4 py-2 px-4 rounded-lg" onclick="handleWorldCultureClick()">
                        ‚úàÔ∏è Descobrir Pratos do Mundo
                    </button>
                    <div id="world-culture-result" class="mt-6"></div>
                </div>
            `;
        }
        
        function renderModoFesta() {
            const container = document.getElementById('content-modo-festa');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">üéâ Modo Festa</h2>
                    <p class="text-sm text-gray-600 mb-4">Planeje um jantar especial! Informe o n√∫mero de convidados e a IA criar√° um menu vegetariano completo para impressionar.</p>
                    
                    <div class="mb-4">
                        <label for="party-people-input" class="block text-sm font-medium text-gray-700">N√∫mero de Convidados</label>
                        <input type="number" id="party-people-input" value="4" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="mb-4">
                         <label for="party-instructions-input" class="block text-sm font-medium text-gray-700">Instru√ß√µes Especiais (Opcional)</label>
                         <textarea id="party-instructions-input" class="mt-1 w-full h-20 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-400" placeholder="Ex: um prato principal sem gl√∫ten, uma sobremesa sem lactose..."></textarea>
                    </div>

                    <button class="gemini-button w-full mt-4 py-2 px-4 rounded-lg" onclick="handlePartyModeClick()">
                        üéâ Gerar Menu de Festa
                    </button>
                    <div id="party-mode-result" class="mt-6"></div>
                </div>
            `;
        }

        window.toggleAccordion = function(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('svg');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function renderGerar() {
            const container = document.getElementById('content-gerar');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-bold text-emerald-600 mb-3">üìù Gerador de Plano Alimentar</h2>
                    <p class="text-sm text-gray-600 mb-4">Insira os detalhes abaixo, liste seus ingredientes e a IA criar√° um plano semanal completo.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="people-input" class="block text-sm font-medium text-gray-700">Pessoas</label>
                            <input type="number" id="people-input" value="2" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label for="start-date-input" class="block text-sm font-medium text-gray-700">Data de In√≠cio</label>
                            <input type="date" id="start-date-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label for="end-date-input" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                            <input type="date" id="end-date-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>

                    <div class="mb-4">
                         <label for="special-instructions-input" class="block text-sm font-medium text-gray-700">Instru√ß√µes Especiais (Opcional)</label>
                         <textarea id="special-instructions-input" class="mt-1 w-full h-20 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-400" placeholder="Ex: Focar em pratos com arroz e feij√£o; Receitas mais elaboradas aos fins de semana..."></textarea>
                    </div>

                    <div>
                         <label for="inventory-input" class="block text-sm font-medium text-gray-700">Seu Estoque (um ingrediente por linha)</label>
                         <textarea id="inventory-input" class="mt-1 w-full h-40 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-400" placeholder="Ex:\n5 espigas de milho\n3 mangas\n2 alhos por√≥\n1kg de feij√£o carioca... (Se deixar em branco, um card√°pio aleat√≥rio ser√° gerado)"></textarea>
                    </div>
                    
                    <div id="gerador-feedback" class="mt-4 text-center"></div>

                    <button id="generate-plan-button" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Gerar Novo Plano com IA
                    </button>
                </div>
            `;
            const startDateInput = document.getElementById('start-date-input');
            const endDateInput = document.getElementById('end-date-input');
            const today = new Date();
            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(today.getDate() + 6);
            startDateInput.value = today.toISOString().split('T')[0];
            endDateInput.value = sevenDaysFromNow.toISOString().split('T')[0];
            document.getElementById('generate-plan-button').addEventListener('click', handleGeneratePlanClick);
        }

        // --- GEMINI API LOGIC ---
        async function handleGeneratePlanClick() {
            const inventory = document.getElementById('inventory-input').value;
            const specialInstructions = document.getElementById('special-instructions-input').value;
            const people = document.getElementById('people-input').value;
            const startDate = document.getElementById('start-date-input').value;
            const endDate = document.getElementById('end-date-input').value;
            const feedbackDiv = document.getElementById('gerador-feedback');
            const button = document.getElementById('generate-plan-button');

            if (GEMINI_API_KEY === "SUA_CHAVE_API_VAI_AQUI") {
                 feedbackDiv.innerHTML = `<p class="text-red-500 text-sm">Por favor, insira sua chave de API do Google no c√≥digo do arquivo index.html.</p>`;
                 return;
            }

             if (!people || !startDate || !endDate) {
                feedbackDiv.innerHTML = `<p class="text-red-500 text-sm">Por favor, preencha a quantidade de pessoas e as datas.</p>`;
                return;
            }

            feedbackDiv.innerHTML = `<div class="flex justify-center items-center"><div class="spinner !w-6 !h-6"></div><p class="ml-3 text-gray-600">Gerando seu plano... Isso pode levar um momento.</p></div>`;
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const startDateObj = new Date(startDate + 'T00:00:00');
                const endDateObj = new Date(endDate + 'T00:00:00');
                const diffTime = Math.abs(endDateObj - startDateObj);
                const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                const newPlan = await callGeminiForPlan(inventory, people, totalDays, specialInstructions);
                
                mealPlanData.estoqueInicial = inventory;
                
                const diasDaSemana = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];

                if (newPlan.cardapio && newPlan.cardapio.length > 0) {
                    for (let i = 0; i < newPlan.cardapio.length; i++) {
                        const currentDate = new Date(startDateObj);
                        currentDate.setDate(startDateObj.getDate() + i);
                        
                        const day = currentDate.getDate().toString().padStart(2, '0');
                        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                        const year = currentDate.getFullYear().toString().slice(-2);
                        const diaSemana = diasDaSemana[currentDate.getDay()];
                        
                        newPlan.cardapio[i].dia = `${day}/${month}/${year} - ${diaSemana}`;
                    }
                }

                mealPlanData.cardapio = newPlan.cardapio;
                mealPlanData.lista = newPlan.lista;
                mealPlanData.receitas = newPlan.receitas;
                cardapioCurrentPage = 1; // Reset pagination
                generatedWorldRecipes = []; // Reset world recipes
                
                renderAll();
                feedbackDiv.innerHTML = `<p class="text-green-600 text-sm font-semibold">Seu novo plano foi gerado com sucesso!</p>`;
                showTab('cardapio');
            } catch (error) {
                console.error("Plan Generation Error:", error);
                feedbackDiv.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function callGeminiForPlan(inventory, people, totalDays, specialInstructions) {
            const instructionsText = specialInstructions.trim() !== '' ? `Instru√ß√µes Especiais a seguir: ${specialInstructions}` : '';
            const inventoryText = inventory.trim() !== '' ? `Estoque dispon√≠vel:\n${inventory}` : 'O usu√°rio n√£o forneceu um estoque. Crie um card√°pio vegetariano aleat√≥rio, variado e equilibrado.';

            const prompt = `Voc√™ √© a NutriVeg IA, uma nutricionista virtual especialista em criar planos alimentares vegetarianos. Baseado na seguinte lista de ingredientes de estoque (incluindo quantidades), crie um plano alimentar completo para ${totalDays} dias para ${people} adultos. O plano deve maximizar o uso do estoque. ${instructionsText} A resposta DEVE ser um objeto JSON, sem nenhum texto ou formata√ß√£o extra. O JSON deve ter a seguinte estrutura: { "cardapio": [{ "dia": "String (apenas o nome do dia da semana, ex: 'Segunda-feira')", "cafe": "String", "almoco": "String", "jantar": "String", "lanches": "String" }], "lista": { "Categoria": ["item1", "item2"] }, "receitas": [{ "titulo": "String", "ingredientes": ["String"], "preparo": ["String"] }] }. Gere uma receita detalhada, mesmo que simples, para CADA refei√ß√£o do card√°pio (caf√©, almo√ßo, jantar e lanches). O t√≠tulo da receita deve corresponder exatamente ao nome da refei√ß√£o no card√°pio para facilitar a busca. A 'lista' (lista de compras) deve conter APENAS os itens necess√°rios para completar as receitas que N√ÉO est√£o na lista de 'Estoque dispon√≠vel'. As receitas devem ser criadas considerando as quantidades do estoque. Por exemplo, se o estoque tem '2 abobrinhas', n√£o crie receitas que usem 3. N√£o invente receitas, use como base pratos conhecidos.

${inventoryText}`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`A chamada para a API falhou com o status: ${response.status}. Verifique sua chave de API.`);
            
            const result = await response.json();

            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const textResponse = result.candidates[0].content.parts[0].text;
                const jsonStart = textResponse.indexOf('{');
                const jsonEnd = textResponse.lastIndexOf('}');

                if (jsonStart !== -1 && jsonEnd > jsonStart) {
                    const jsonString = textResponse.substring(jsonStart, jsonEnd + 1);
                    try {
                        return JSON.parse(jsonString);
                    } catch (e) {
                        console.error("Error parsing extracted JSON:", e, "String:", jsonString);
                        throw new Error("Falha ao processar a resposta da IA ap√≥s a limpeza.");
                    }
                } else {
                    console.error("N√£o foi poss√≠vel encontrar um objeto JSON v√°lido na resposta da IA:", textResponse);
                    throw new Error("Formato de resposta inv√°lido da IA.");
                }
            } else {
                console.warn("Estrutura de resposta da API inesperada para gera√ß√£o de plano:", result);
                if (result.promptFeedback?.blockReason) {
                    throw new Error(`Requisi√ß√£o bloqueada: ${result.promptFeedback.blockReason}`);
                }
                if(result.error) {
                    throw new Error(`Erro da API: ${result.error.message}`);
                }
                throw new Error("Nenhum conte√∫do recebido da API para gera√ß√£o de plano.");
            }
        }
        
        window.handleShareWeekToWhatsApp = function() {
            if (!mealPlanData.cardapio || mealPlanData.cardapio.length === 0) {
                alert("Gere um card√°pio primeiro para poder compartilhar.");
                return;
            }
            let message = `*Plano Alimentar da Semana* ü•ó\n\n`;
            mealPlanData.cardapio.forEach(day => {
                message += `*${day.dia}*\n`;
                message += `  - Caf√©: ${day.cafe}\n`;
                message += `  - Almo√ßo: ${day.almoco}\n`;
                message += `  - Jantar: ${day.jantar}\n`;
                message += `  - Lanches: ${day.lanches}\n\n`;
            });
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        window.handleShareListToWhatsApp = function() {
            if (!mealPlanData.lista || Object.keys(mealPlanData.lista).length === 0) {
                alert("N√£o h√° lista de compras para compartilhar.");
                return;
            }
            let message = `*Lista de Compras* üõí\n\n`;
            for (const categoria in mealPlanData.lista) {
                message += `*${categoria}*\n`;
                mealPlanData.lista[categoria].forEach(item => {
                    message += `- ${item}\n`;
                });
                message += `\n`;
            }
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        window.handleSavingsClick = function() {
            const shoppingList = Object.values(mealPlanData.lista).flat().join(', ');
            if (!shoppingList) {
                openGeminiModal('‚ú® Dicas de Economia', "N√£o h√° itens na sua lista de compras para analisar, mas uma dica geral √© sempre comprar vegetais da esta√ß√£o, que s√£o mais baratos e saborosos!");
                return;
            };
            const prompt = `Voc√™ √© a NutriVeg IA. Baseado nesta lista de compras vegetariana, d√™ 3 dicas pr√°ticas e curtas para economizar dinheiro sem sacrificar a nutri√ß√£o. Fale sobre produtos da esta√ß√£o, op√ß√µes congeladas vs. frescas, ou alternativas de prote√≠nas mais baratas. Lista: ${shoppingList}.`;
            openGeminiModal('‚ú® Dicas de Economia', prompt);
        }
        
        window.handleLeftoversClick = function(almoco, jantar) {
            const prompt = `Voc√™ √© a NutriVeg IA. Tive para o almo√ßo "${almoco}" e para o jantar "${jantar}". D√™ uma ideia criativa e simples para combinar as sobras dessas duas refei√ß√µes em um novo prato para amanh√£. Use como base receitas conhecidas. Responda em no m√°ximo 4 frases.`;
            openGeminiModal('üí° Ideias para Sobras', prompt);
        }

        window.handleGeminiClick = function(type, mealName, mealDesc) {
            let prompt = '';
            let title = '';
            if (type === 'variacao') {
                title = `‚ú® Varia√ß√£o para o ${mealName}`;
                prompt = `Voc√™ √© a NutriVeg IA. Para a refei√ß√£o "${mealName}", que √© "${mealDesc}", sugira uma √∫nica alternativa vegetariana criativa, baseada em receitas conhecidas. Responda em no m√°ximo 4 frases.`;
            } else {
                title = `‚ú® Dica para o ${mealName}`;
                prompt = `Voc√™ √© a NutriVeg IA. D√™ uma dica de chef ou um fato nutricional sobre a refei√ß√£o "${mealDesc}". Responda em no m√°ximo 4 frases.`;
            }
            openGeminiModal(title, prompt);
        }

        window.handleNutriAnalysisClick = async function() {
            const resultDiv = document.getElementById('nutri-result');
            resultDiv.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-4 text-gray-500">‚ú® Analisando...</p></div>';
            const menuText = JSON.stringify(mealPlanData.cardapio);
            const prompt = `Voc√™ √© a NutriVeg IA, especialista em nutri√ß√£o e planejamento. Para o card√°pio semanal a seguir, forne√ßa duas se√ß√µes claras em formato de t√≥picos: 1. **Justificativa Nutricional:** Explique por que este card√°pio √© balanceado, mencionando a combina√ß√£o de macronutrientes, variedade de vitaminas e minerais. 2. **Plano de A√ß√£o para Marmitas:** Crie um guia passo a passo para preparar a maioria das refei√ß√µes da semana em um √∫nico dia. D√™ dicas de como cozinhar os gr√£os, preparar os vegetais, cozinhar as prote√≠nas e montar as marmitas para manter o frescor. Card√°pio: ${menuText}`;
            try {
                const resultText = await callGeminiForText(prompt);
                resultDiv.innerHTML = resultText.replace(/\n/g, '<br>');
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        window.handleQuickRecipeClick = async function() {
            const ingredients = document.getElementById('quick-recipe-input').value;
            const resultDiv = document.getElementById('quick-recipe-result');
            if (ingredients.trim() === '') {
                resultDiv.innerHTML = `<p class="text-red-500 text-sm">Por favor, insira alguns ingredientes.</p>`;
                return;
            }
            resultDiv.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-4 text-gray-500">‚ú® Buscando receitas...</p></div>';
            const prompt = `Voc√™ √© a NutriVeg IA. Com base nos seguintes ingredientes: ${ingredients}, sugira 3 receitas vegetarianas conhecidas e simples. Formate a resposta como um objeto JSON com uma chave "receitas", que √© um array de objetos, cada um com "titulo", "ingredientes" (array de strings) e "preparo" (array de strings). N√£o invente receitas.`;
            
            try {
                const resultText = await callGeminiForText(prompt);
                const jsonStart = resultText.indexOf('{');
                const jsonEnd = resultText.lastIndexOf('}');
                const jsonString = resultText.substring(jsonStart, jsonEnd + 1);
                const recipes = JSON.parse(jsonString).receitas;
                
                resultDiv.innerHTML = recipes.map(receita => `
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">üí° ${receita.titulo}</h3>
                        <div class="text-sm text-gray-700 space-y-3">
                            <div>
                                <h4 class="font-medium mb-1">Ingredientes:</h4>
                                <ul class="list-disc list-inside space-y-1">${receita.ingredientes.map(ing => `<li>${ing}</li>`).join('')}</ul>
                            </div>
                            <div>
                                <h4 class="font-medium mb-1">Modo de Preparo:</h4>
                                <ol class="list-decimal list-inside space-y-1">${receita.preparo.map(passo => `<li>${passo}</li>`).join('')}</ol>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        window.handleWorldCultureClick = async function() {
            const resultDiv = document.getElementById('world-culture-result');
            resultDiv.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-4 text-gray-500">‚ú® Viajando pelo mundo...</p></div>';
            const exclusionList = generatedWorldRecipes.join(', ');
            const exclusionPrompt = exclusionList ? `N√£o inclua estas receitas que j√° foram mostradas: ${exclusionList}.` : '';

            const prompt = `Voc√™ √© a NutriVeg IA. Forne√ßa 3 receitas de pratos vegetarianos ou veganos, de 3 pa√≠ses diferentes. Use apenas receitas conhecidas e tradicionais. ${exclusionPrompt} Formate a resposta como um objeto JSON com uma chave "receitas", que √© um array de objetos, cada um com "titulo", "pais", "ingredientes" (array de strings) e "preparo" (array de strings). N√£o invente receitas.`;
            
            try {
                const resultText = await callGeminiForText(prompt);
                const jsonStart = resultText.indexOf('{');
                const jsonEnd = resultText.lastIndexOf('}');
                const jsonString = resultText.substring(jsonStart, jsonEnd + 1);
                const recipes = JSON.parse(jsonString).receitas;
                
                recipes.forEach(r => generatedWorldRecipes.push(r.titulo));

                resultDiv.innerHTML = recipes.map(receita => `
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">‚úàÔ∏è ${receita.titulo} (${receita.pais})</h3>
                        <div class="text-sm text-gray-700 space-y-3">
                             <div>
                                <h4 class="font-medium mb-1">Ingredientes:</h4>
                                <ul class="list-disc list-inside space-y-1">${receita.ingredientes.map(ing => `<li>${ing}</li>`).join('')}</ul>
                            </div>
                            <div>
                                <h4 class="font-medium mb-1">Modo de Preparo:</h4>
                                <ol class="list-decimal list-inside space-y-1">${receita.preparo.map(passo => `<li>${passo}</li>`).join('')}</ol>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        window.handlePartyModeClick = async function() {
            const people = document.getElementById('party-people-input').value;
            const instructions = document.getElementById('party-instructions-input').value;
            const resultDiv = document.getElementById('party-mode-result');

            if (!people || people < 1) {
                resultDiv.innerHTML = `<p class="text-red-500 text-sm">Por favor, insira um n√∫mero v√°lido de convidados.</p>`;
                return;
            }

            resultDiv.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-4 text-gray-500">‚ú® Criando um menu especial...</p></div>';
            
            const instructionsText = instructions.trim() !== '' ? `Leve em conta as seguintes instru√ß√µes especiais: ${instructions}.` : '';

            const prompt = `Voc√™ √© a NutriVeg IA, uma chef especialista em menus vegetarianos para eventos. Crie um menu de festa completo para ${people} pessoas. ${instructionsText} O menu deve conter: 1 entrada, 1 prato principal, 1 sobremesa e 1 bebida. Use apenas receitas conhecidas e que impressionem os convidados. Forne√ßa tamb√©m dicas de apresenta√ß√£o e um plano de timing para o preparo. A resposta DEVE ser um objeto JSON, sem nenhum texto ou formata√ß√£o extra, com a seguinte estrutura: 
            { 
              "menu": {
                "Entrada": { "titulo": "String", "ingredientes": ["String"], "preparo": ["String"] },
                "Prato Principal": { "titulo": "String", "ingredientes": ["String"], "preparo": ["String"] },
                "Sobremesa": { "titulo": "String", "ingredientes": ["String"], "preparo": ["String"] },
                "Bebida": { "titulo": "String", "ingredientes": ["String"], "preparo": ["String"] }
              },
              "dicas": {
                "apresentacao": "String com dicas de como servir e decorar os pratos.",
                "timing": "String com um plano de quando preparar cada item (ex: 'V√©spera', 'Manh√£ do evento', 'Pouco antes de servir')."
              }
            }`;
            
            try {
                const resultText = await callGeminiForText(prompt);
                const jsonStart = resultText.indexOf('{');
                const jsonEnd = resultText.lastIndexOf('}');
                const jsonString = resultText.substring(jsonStart, jsonEnd + 1);
                const partyPlan = JSON.parse(jsonString);
                
                let resultHTML = '';

                // Render Menu
                for (const [category, recipe] of Object.entries(partyPlan.menu)) {
                    resultHTML += `
                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-semibold text-gray-800 mb-2">${category}: ${recipe.titulo}</h3>
                            <div class="text-sm text-gray-700 space-y-3">
                                <div>
                                    <h4 class="font-medium mb-1">Ingredientes:</h4>
                                    <ul class="list-disc list-inside space-y-1">${recipe.ingredientes.map(ing => `<li>${ing}</li>`).join('')}</ul>
                                </div>
                                <div>
                                    <h4 class="font-medium mb-1">Modo de Preparo:</h4>
                                    <ol class="list-decimal list-inside space-y-1">${recipe.preparo.map(passo => `<li>${passo}</li>`).join('')}</ol>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Render Dicas
                resultHTML += `
                    <div class="border-t pt-4 mt-4 bg-emerald-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-emerald-800 mb-2">‚≠ê Dicas da Chef</h3>
                        <div class="text-sm text-emerald-700 space-y-3">
                            <div>
                                <h4 class="font-medium mb-1">Apresenta√ß√£o:</h4>
                                <p>${partyPlan.dicas.apresentacao}</p>
                            </div>
                            <div>
                                <h4 class="font-medium mb-1">Timing de Preparo:</h4>
                                <p>${partyPlan.dicas.timing}</p>
                            </div>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        async function openGeminiModal(title, prompt) {
            const modal = document.getElementById('geminiModal');
            const modalTitle = document.getElementById('geminiModalTitle');
            const modalContent = document.getElementById('geminiModalContent');
            
            modal.classList.remove('hidden');
            modalTitle.textContent = title;
            modalContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div><p class="ml-4 text-gray-500">‚ú® Pensando...</p></div>';

            try {
                const resultText = await callGeminiForText(prompt);
                modalContent.innerHTML = resultText.replace(/\n/g, '<br>');
            } catch (error) {
                console.error("Gemini API Error:", error);
                modalContent.textContent = error.message;
            }
        }

        async function callGeminiForText(prompt) {
            if (GEMINI_API_KEY === "SUA_CHAVE_API_VAI_AQUI") {
                 throw new Error("Por favor, insira sua chave de API do Google no c√≥digo do arquivo index.html.");
            }
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`A chamada para a API falhou com o status: ${response.status}. Verifique sua chave de API.`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.warn("Unexpected API response structure:", result);
                if (result.promptFeedback?.blockReason) { return `N√£o foi poss√≠vel gerar uma resposta devido a: ${result.promptFeedback.blockReason}.`; }
                if(result.error) {
                    throw new Error(`Erro da API: ${result.error.message}`);
                }
                throw new Error("Nenhum conte√∫do recebido da API.");
            }
        }

        // --- TAB & MODAL LOGIC ---
        window.showTab = function(tabName) {
            const contents = ['cardapio', 'lista', 'receitas', 'gerar', 'nutri', 'receita-rapida', 'cultura-mundial', 'modo-festa'];
            contents.forEach(content => {
                document.getElementById(`content-${content}`).classList.toggle('hidden', content !== tabName);
                document.getElementById(`tab-${content}`).classList.toggle('tab-active', content === tabName);
            });
        }

        function setupModals() {
            const geminiModal = document.getElementById('geminiModal');
            const closeGeminiModalButton = document.getElementById('closeGeminiModalButton');
            closeGeminiModalButton.addEventListener('click', () => geminiModal.classList.add('hidden'));
        }

        // --- INITIALIZATION ---
        function init() {
            renderAll();
            setupModals();
            showTab('gerar'); // Start on the 'Gerar Plano' tab
        }

        init();
    </script>
</body>
</html>
